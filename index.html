<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Quiz Master - Smart MCQ Extractor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #FF6B6B;
            --primary-light: #FF8E8E;
            --primary-dark: #FF5252;
            --secondary: #4ECDC4;
            --accent: #FFD166;
            --success: #06D6A0;
            --warning: #FF9A3D;
            --danger: #EF476F;
            --info: #118AB2;
            --light: #F8F9FA;
            --dark: #2D3047;
            --gray: #8D99AE;
            --gray-light: #EDF2F4;
            --purple: #7209B7;
            --blue: #4361EE;
            --border-radius: 16px;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: var(--dark);
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body.dark-mode {
            background: linear-gradient(-45deg, #141E30, #243B55, #0f2027, #203a43);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: var(--light);
        }

        /* Animated Background Doodles */
        .bg-doodle {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }

        .doodle {
            position: absolute;
            opacity: 0.1;
        }

        .doodle-1 { top: 10%; left: 5%; animation: float 20s infinite ease-in-out; }
        .doodle-2 { top: 60%; right: 10%; animation: float 25s infinite ease-in-out reverse; }
        .doodle-3 { bottom: 20%; left: 15%; animation: float 30s infinite ease-in-out; }
        .doodle-4 { top: 30%; right: 20%; animation: float 22s infinite ease-in-out reverse; }

        .doodle-5 {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            opacity: 0.08;
            animation: pulse 4s infinite;
        }

        .doodle-6 {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            background: linear-gradient(45deg, var(--secondary), var(--info));
            opacity: 0.08;
            animation: morph 8s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(10deg); }
            66% { transform: translateY(15px) rotate(-10deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.08; }
            50% { transform: scale(1.2); opacity: 0.12; }
        }

        @keyframes morph {
            0%, 100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
            33% { border-radius: 58% 42% 75% 25% / 76% 46% 54% 24%; }
            66% { border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%; }
        }

        /* Header - Hidden during quiz on mobile */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: var(--box-shadow);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            border-bottom: 2px solid var(--primary);
            height: 70px;
        }

        body.quiz-active .header {
            display: none;
        }

        .dark-mode .header {
            background: rgba(45, 48, 71, 0.95);
            border-bottom-color: var(--accent);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .logo {
            height: 50px;
            width: auto;
            border-radius: 10px;
            animation: logoPulse 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            object-fit: contain;
        }

        @keyframes logoPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .drawer-toggle, .home-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }

        .home-btn {
            background: linear-gradient(135deg, var(--info) 0%, var(--blue) 100%);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
        }

        .drawer-toggle:hover, .home-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.4);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar/Drawer */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            box-shadow: 10px 0 25px rgba(0, 0, 0, 0.08);
            transform: translateX(-100%);
            transition: var(--transition);
            position: fixed;
            top: 70px;
            bottom: 0;
            z-index: 999;
            border-right: 2px solid var(--primary);
        }

        .dark-mode .sidebar {
            background: rgba(45, 48, 71, 0.95);
            border-right-color: var(--accent);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .sidebar-btn {
            padding: 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--info) 0%, var(--blue) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-start;
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
            text-align: left;
        }

        .sidebar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.4);
        }

        .sidebar-btn:nth-child(2) {
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            box-shadow: 0 6px 15px rgba(255, 209, 102, 0.3);
        }

        .sidebar-btn:nth-child(3) {
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary) 100%);
            box-shadow: 0 6px 15px rgba(6, 214, 160, 0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            transition: var(--transition);
            width: 100%;
            position: relative;
            overflow-y: auto;
            max-height: calc(100vh - 70px);
        }

        .sidebar.open + .main-content {
            margin-left: var(--sidebar-width);
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .sidebar.open + .main-content {
                margin-left: 0;
            }
            
            .header {
                padding: 0.8rem 1rem;
            }
            
            .logo {
                height: 40px;
            }
            
            .logo-text {
                display: none;
            }
            
            .sidebar {
                width: 100%;
            }
        }

        /* Name Input Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.4s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
        }

        .dark-mode .modal-content {
            background: #2D3047;
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 800;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            background: white;
        }

        .dark-mode .modal-input {
            background: #4A5568;
            border-color: #4A5568;
            color: white;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Home/Library Section */
        .home-section {
            display: block;
        }

        .library-section {
            display: none;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            margin-bottom: 1rem;
            border: 3px dashed var(--primary);
            transition: var(--transition);
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
            max-width: 100%;
            margin: 0 auto;
        }

        .upload-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--secondary), var(--info));
        }

        .dark-mode .upload-section {
            background: rgba(45, 48, 71, 0.95);
            border-color: var(--accent);
        }

        .upload-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .upload-image-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 200px;
            margin: 0 auto 1.5rem;
            cursor: pointer;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: var(--transition);
        }

        .upload-image-container:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .upload-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }

        .upload-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 107, 107, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            opacity: 0;
            transition: var(--transition);
        }

        .upload-image-container:hover .upload-image-overlay {
            opacity: 1;
        }

        .upload-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
            text-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .upload-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .upload-tab {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark-mode .upload-tab {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .upload-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
            transform: translateY(-3px);
        }

        .upload-tab:hover:not(.active) {
            background: linear-gradient(135deg, var(--info) 0%, var(--blue) 100%);
            color: white;
        }

        .upload-tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .upload-tab-content.active {
            display: block;
        }

        .how-it-works-btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            color: var(--dark);
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            margin: 1rem auto;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(255, 209, 102, 0.3);
        }

        .how-it-works-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 209, 102, 0.4);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 400px;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-label {
            display: inline-block;
            padding: 1.2rem 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            width: 100%;
        }

        .file-label:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .paste-textarea {
            width: 100%;
            max-width: 100%;
            min-height: 200px;
            padding: 1.5rem;
            border: 2px solid var(--primary);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            resize: vertical;
            background: white;
            transition: var(--transition);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .dark-mode .paste-textarea {
            background: #4A5568;
            border-color: var(--accent);
            color: white;
        }

        .paste-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 209, 102, 0.2);
        }

        .paste-example {
            background: linear-gradient(135deg, rgba(255, 209, 102, 0.1) 0%, rgba(255, 209, 102, 0.05) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem auto;
            max-width: 100%;
            text-align: left;
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .paste-example h4 {
            color: var(--primary);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .paste-example pre {
            background: rgba(0,0,0,0.05);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-top: 0.8rem;
        }

        .dark-mode .paste-example pre {
            background: rgba(255,255,255,0.1);
        }

        .copy-example-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--info) 0%, var(--blue) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.3);
        }

        .extract-btn {
            padding: 1.2rem 3rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 20px rgba(255, 209, 102, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-top: 1rem;
        }

        .extract-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(255, 209, 102, 0.4);
        }

        .extract-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-info {
            margin-top: 1rem;
            color: var(--primary);
            font-size: 1rem;
            font-weight: 600;
            padding: 0.8rem 1.5rem;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 12px;
            display: inline-block;
            border: 2px solid rgba(255, 107, 107, 0.2);
            max-width: 500px;
            word-break: break-all;
        }

        /* Library Section */
        .library-title {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .library-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .library-container {
                grid-template-columns: 1fr;
            }
        }

        .pdf-folder {
            background: linear-gradient(135deg, #F8FAFC 0%, #EDF2F7 100%);
            border-radius: var(--border-radius);
            padding: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .pdf-folder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--accent));
        }

        .dark-mode .pdf-folder {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
        }

        .pdf-folder:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .folder-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .folder-actions {
            display: flex;
            gap: 8px;
        }

        .folder-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .folder-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .folder-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark);
            line-height: 1.3;
        }

        .dark-mode .folder-name {
            color: white;
        }

        .folder-quiz-number {
            font-size: 0.95rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .folder-meta {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 1.2rem;
            border-top: 2px dashed rgba(0,0,0,0.1);
        }

        .dark-mode .folder-meta {
            border-top-color: rgba(255,255,255,0.1);
        }

        .meta-item {
            text-align: center;
            flex: 1;
        }

        .meta-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
            display: block;
        }

        .meta-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.3rem;
        }

        .dark-mode .meta-label {
            color: #CBD5E0;
        }

        .performance-chart {
            height: 100px;
            margin-top: 1.2rem;
            position: relative;
        }

        .no-quizzes {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .no-quizzes i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Quiz Selection Section */
        .quiz-selection-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
            animation: slideUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .quiz-selection-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--success), var(--info));
        }

        .dark-mode .quiz-selection-section {
            background: rgba(45, 48, 71, 0.95);
        }

        .selection-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            text-align: center;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--info) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .back-to-library {
            margin-bottom: 1.5rem;
        }

        .back-btn {
            padding: 0.7rem 1.2rem;
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .dark-mode .back-btn {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }

        .subject-filters {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .subject-filter {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            white-space: nowrap;
        }

        .dark-mode .subject-filter {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: var(--light);
        }

        .subject-filter:hover, .subject-filter.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
        }

        .quiz-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.2rem;
            margin-top: 1.2rem;
        }

        @media (max-width: 768px) {
            .quiz-cards-container {
                grid-template-columns: 1fr;
            }
        }

        .quiz-card {
            background: linear-gradient(135deg, #F8FAFC 0%, #EDF2F7 100%);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .quiz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--accent));
        }

        .dark-mode .quiz-card {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
        }

        .quiz-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .quiz-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .quiz-number {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .quiz-badge {
            padding: 0.3rem 0.8rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            color: var(--dark);
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .quiz-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark);
            line-height: 1.3;
        }

        .dark-mode .quiz-title {
            color: white;
        }

        .quiz-meta {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 2px dashed rgba(0,0,0,0.1);
        }

        .dark-mode .quiz-meta {
            border-top-color: rgba(255,255,255,0.1);
        }

        .quiz-performance {
            margin-top: 0.8rem;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            text-align: center;
        }

        .dark-mode .quiz-performance {
            background: rgba(255, 255, 255, 0.1);
        }

        .performance-score {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--success);
            margin-bottom: 0.2rem;
        }

        .performance-label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* NEW FULL SCREEN QUIZ SECTION FOR MOBILE */
        .quiz-section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }

        .dark-mode .quiz-section {
            background: #2D3047;
        }

        /* Quiz Header - Compact */
        .quiz-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .quiz-header-info {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            width: 100%;
            justify-content: space-between;
        }

        .quiz-header-info::-webkit-scrollbar {
            display: none;
        }

        .question-progress {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
        }

        .quiz-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 70px;
            justify-content: center;
            white-space: nowrap;
        }

        .total-questions-btn {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            color: white;
            white-space: nowrap;
        }

        .total-questions-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .quiz-header {
                padding: 0.6rem;
            }
            
            .quiz-header-info {
                gap: 0.5rem;
                width: 100%;
                justify-content: space-between;
            }
            
            .question-progress,
            .quiz-timer,
            .total-questions-btn {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
                min-width: auto;
                flex: 1;
                justify-content: center;
            }
        }

        /* Main Quiz Content - Full Screen */
        .quiz-main-content {
            padding: 1.5rem;
            max-width: 100%;
            margin: 0;
            height: calc(100vh - 150px);
            display: flex;
            flex-direction: column;
        }

        .question-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* REMOVED: .question-number class - Red text removed */

        .question-text {
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            color: var(--dark);
            padding: 1rem;
            background: linear-gradient(135deg, #F8FAFC 0%, #EDF2F7 100%);
            border-radius: 10px;
            border: 1px solid var(--gray-light);
        }

        .dark-mode .question-text {
            color: white;
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            border-color: #4A5568;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.6rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .options-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .option {
            padding: 0.7rem;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            background: white;
            min-height: 50px;
        }

        .dark-mode .option {
            border-color: #4A5568;
            background: #2D3748;
        }

        .option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%);
        }

        .option.correct {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(6, 214, 160, 0.1) 0%, rgba(6, 214, 160, 0.05) 100%);
        }

        .option.incorrect {
            border-color: var(--danger);
            background: linear-gradient(135deg, rgba(239, 71, 111, 0.1) 0%, rgba(239, 71, 111, 0.05) 100%);
        }

        .option-letter {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            flex-shrink: 0;
            transition: var(--transition);
            color: var(--dark);
        }

        .dark-mode .option-letter {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .option.selected .option-letter {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
        }

        .option.correct .option-letter {
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary) 100%);
            color: white;
        }

        .option.incorrect .option-letter {
            background: linear-gradient(135deg, var(--danger) 0%, #FF4D6D 100%);
            color: white;
        }

        /* Solution Container */
        .solution-container {
            background: linear-gradient(135deg, rgba(255, 209, 102, 0.1) 0%, rgba(255, 209, 102, 0.05) 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--accent);
            animation: slideIn 0.4s ease-out;
            max-height: none;
            overflow: visible;
        }

        .dark-mode .solution-container {
            background: linear-gradient(135deg, rgba(255, 209, 102, 0.2) 0%, rgba(255, 209, 102, 0.1) 100%);
        }

        .solution-title {
            font-weight: 800;
            margin-bottom: 0.8rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .solution-text {
            line-height: 1.5;
            color: var(--dark);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .dark-mode .solution-text {
            color: white;
        }

        /* Fixed Quiz Controls at Bottom */
        .quiz-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            border-top: 2px solid var(--gray-light);
            z-index: 100;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        }

        .dark-mode .quiz-controls {
            background: #2D3047;
            border-top-color: #4A5568;
        }

        .quiz-btn {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            justify-content: center;
            min-height: 44px;
        }

        .quiz-btn.prev {
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            color: var(--dark);
            order: 1;
        }

        .dark-mode .quiz-btn.prev {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .quiz-btn.prev:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .quiz-btn.next {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            order: 3;
        }

        .quiz-btn.next:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 107, 107, 0.3);
        }

        .quiz-btn.submit {
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            color: var(--dark);
            order: 2;
        }

        .quiz-btn.submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 209, 102, 0.3);
        }

        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        @media (max-width: 768px) {
            .quiz-controls {
                padding: 0.6rem;
            }
            
            .quiz-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
                min-height: 40px;
            }
            
            .quiz-btn .btn-text {
                display: inline;
            }
        }

        /* Question Navigator Sidebar */
        .quiz-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 1.2rem;
            box-shadow: var(--box-shadow);
            border: 2px solid var(--primary);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-height: 80vh;
            width: 90%;
            max-width: 400px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dark-mode .quiz-sidebar {
            background: rgba(45, 48, 71, 0.95);
            border-color: var(--accent);
        }

        .quiz-sidebar.show {
            display: block;
            animation: scaleIn 0.3s ease-out;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .navigator-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 1.2rem;
        }

        .question-bubble {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            border: 2px solid transparent;
        }

        .dark-mode .question-bubble {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .question-bubble:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .question-bubble.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
            transform: scale(1.05);
        }

        .question-bubble.answered {
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary) 100%);
            color: white;
        }

        .question-bubble.wrong {
            background: linear-gradient(135deg, var(--danger) 0%, #FF4D6D 100%);
            color: white;
        }

        .question-bubble.skipped {
            background: linear-gradient(135deg, #A0AEC0 0%, #718096 100%);
            color: white;
        }

        /* Sidebar Stats - Compact */
        .sidebar-stats {
            margin-top: 1.2rem;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            border: 2px solid rgba(255, 107, 107, 0.2);
        }

        .dark-mode .sidebar-stats {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-label-sidebar {
            color: var(--dark);
            font-weight: 600;
        }

        .dark-mode .stat-label-sidebar {
            color: white;
        }

        .stat-value-sidebar {
            font-weight: 700;
            color: var(--primary);
        }

        .stat-value-sidebar.correct {
            color: var(--success);
        }

        .stat-value-sidebar.incorrect {
            color: var(--danger);
        }

        .stat-value-sidebar.skipped {
            color: #A0AEC0;
        }

        /* Results Section - Fixed small boxes */
        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            text-align: center;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
            max-width: 800px;
            margin: 0 auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success), var(--info));
        }

        .dark-mode .results-section {
            background: rgba(45, 48, 71, 0.95);
        }

        .results-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .results-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .score-display {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 1rem 0;
            text-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 15px rgba(255, 107, 107, 0.3); }
            to { text-shadow: 0 0 30px rgba(255, 107, 107, 0.6), 0 0 40px rgba(255, 107, 107, 0.4); }
        }

        .performance-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 1rem 0;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .rating-icon {
            font-size: 1.5rem;
        }

        .rating-text {
            font-size: 1.1rem;
        }

        .rating-excellent { color: var(--success); }
        .rating-very-good { color: #4ECDC4; }
        .rating-good { color: #06D6A0; }
        .rating-average { color: #FFD166; }
        .rating-bad { color: #FF9A3D; }
        .rating-very-bad { color: #EF476F; }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin: 1rem 0;
        }

        .result-stat {
            padding: 0.8rem;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .result-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .dark-mode .result-stat {
            background: #4A5568;
        }

        .result-stat.correct {
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary) 100%);
            color: white;
            border-color: var(--success);
        }

        .result-stat.incorrect {
            background: linear-gradient(135deg, var(--danger) 0%, #FF4D6D 100%);
            color: white;
            border-color: var(--danger);
        }

        .result-stat .value {
            font-size: 1.8rem;
            font-weight: 800;
            display: block;
            margin-bottom: 0.2rem;
        }

        .result-stat .label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .result-actions {
            display: flex;
            justify-content: center;
            gap: 0.8rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* How It Works Section */
        .how-it-works-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin: 1rem auto;
            max-width: 800px;
            text-align: left;
        }

        .dark-mode .how-it-works-section {
            background: rgba(45, 48, 71, 0.95);
        }

        .how-it-works-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .how-it-works-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 800;
        }

        .how-it-works-content {
            line-height: 1.6;
            font-size: 1rem;
        }

        .how-it-works-content h3 {
            color: var(--primary);
            margin: 1.5rem 0 0.8rem;
        }

        .how-it-works-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .how-it-works-content li {
            margin-bottom: 0.5rem;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.4s ease-out;
        }

        .overlay-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .overlay-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
        }

        .dark-mode .overlay-content {
            background: #2D3047;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .overlay-title {
            font-size: 1.6rem;
            margin-bottom: 1.2rem;
            color: var(--primary);
            font-weight: 800;
        }

        .overlay-text {
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: var(--dark);
            font-size: 1rem;
        }

        .dark-mode .overlay-text {
            color: white;
        }

        .overlay-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
        }

        /* Rename Quiz Modal */
        .rename-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            min-width: 300px;
        }

        .dark-mode .rename-modal {
            background: #2D3047;
        }

        .rename-modal input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        /* Custom Confirmation Modal */
        .custom-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2001;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .custom-confirm-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .custom-confirm-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--success));
        }

        .dark-mode .custom-confirm-content {
            background: #2D3047;
        }

        .custom-confirm-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: 800;
            text-align: center;
        }

        .custom-confirm-message {
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: var(--dark);
            font-size: 1rem;
            text-align: center;
        }

        .dark-mode .custom-confirm-message {
            color: white;
        }

        .custom-confirm-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .custom-confirm-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
        }

        .custom-confirm-btn.cancel {
            background: linear-gradient(135deg, var(--gray-light) 0%, #E2E8F0 100%);
            color: var(--dark);
            order: 1;
        }

        .dark-mode .custom-confirm-btn.cancel {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            color: white;
        }

        .custom-confirm-btn.confirm {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            order: 2;
        }

        .custom-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 0.5rem;
            }
            
            .upload-section {
                padding: 1.5rem 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .upload-title {
                font-size: 1.5rem;
            }
            
            .upload-image-container {
                height: 150px;
            }
            
            .quiz-selection-section, .library-section {
                padding: 1rem;
            }
            
            .selection-title, .library-title {
                font-size: 1.5rem;
            }
            
            .quiz-card, .pdf-folder {
                padding: 1rem;
            }
            
            .quiz-main-content {
                padding: 1rem;
                height: calc(100vh - 130px);
            }
            
            .question-text {
                font-size: 1rem;
                padding: 0.8rem;
            }
            
            .option {
                padding: 0.6rem;
                min-height: 45px;
            }
            
            .option-letter {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
            
            .results-section {
                padding: 1rem;
                max-height: 85vh;
            }
            
            .score-display {
                font-size: 2rem;
            }
            
            .results-stats {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }
            
            .result-stat {
                padding: 0.6rem;
            }
            
            .result-stat .value {
                font-size: 1.5rem;
            }
            
            .how-it-works-section {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .logo-text {
                display: none;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .file-label, .extract-btn {
                font-size: 0.9rem;
                padding: 0.8rem 1.5rem;
            }
            
            .question-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .question-bubble {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Background Doodles -->
    <div class="bg-doodle">
        <div class="doodle doodle-1"></div>
        <div class="doodle doodle-2"></div>
        <div class="doodle doodle-3"></div>
        <div class="doodle doodle-4"></div>
        <div class="doodle-5" style="top: 15%; right: 10%;"></div>
        <div class="doodle-6" style="bottom: 10%; left: 10%;"></div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div class="custom-confirm-modal" id="customConfirmModal">
        <div class="custom-confirm-content">
            <h3 class="custom-confirm-title" id="customConfirmTitle">Confirm Action</h3>
            <div class="custom-confirm-message" id="customConfirmMessage">
                Are you sure you want to perform this action?
            </div>
            <div class="custom-confirm-buttons">
                <button class="custom-confirm-btn cancel" id="customConfirmCancelBtn">
                    <i class="fas fa-times"></i> No, Cancel
                </button>
                <button class="custom-confirm-btn confirm" id="customConfirmOkBtn">
                    <i class="fas fa-check"></i> Yes, Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Name Input Modal -->
    <div class="modal-overlay" id="nameModal">
        <div class="modal-content">
            <h3 class="modal-title">Name Your Quiz Set</h3>
            <p style="margin-bottom: 1.5rem; color: var(--dark);">Give a custom name for this quiz folder. This name will be used for your quizzes.</p>
            <input type="text" id="folderNameInput" class="modal-input" placeholder="Enter folder name (e.g., Physics Chapter 1, Math Quiz, etc.)" value="">
            <div class="modal-buttons">
                <button class="quiz-btn prev" id="cancelNameBtn">Cancel</button>
                <button class="quiz-btn next" id="confirmNameBtn">Continue</button>
            </div>
        </div>
    </div>

    <!-- Rename Quiz Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal-content">
            <h3 class="modal-title">Rename Quiz</h3>
            <p style="margin-bottom: 1.5rem; color: var(--dark);">Enter a new name for this quiz:</p>
            <input type="text" id="renameInput" class="modal-input" placeholder="Enter new quiz name" value="">
            <div class="modal-buttons">
                <button class="quiz-btn prev" id="cancelRenameBtn">Cancel</button>
                <button class="quiz-btn next" id="confirmRenameBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo-container" id="homeLogo">
            <img src="https://image2url.com/images/1766472315313-9ae4bb3e-67af-4f5d-997d-9f7aefb27a22.png" alt="PDF Quiz Master Logo" class="logo">
            <span class="logo-text">PDF2QUIZ</span>
        </div>
        <div class="header-actions">
            <button class="home-btn" id="homeBtn" title="Home">
                <i class="fas fa-home"></i>
            </button>
            <button class="drawer-toggle" id="drawerToggle" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar/Drawer -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-buttons">
                <button class="sidebar-btn" id="themeBtn">
                    <i class="fas fa-palette"></i> Change Theme
                </button>
                <button class="sidebar-btn" id="shareBtn">
                    <i class="fas fa-share-alt"></i> Share App
                </button>
                <button class="sidebar-btn" id="aboutBtn">
                    <i class="fas fa-info-circle"></i> About & Help
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Home/Library Section -->
            <div class="home-section" id="homeSection">
                <!-- Upload Section -->
                <section class="upload-section" id="uploadSection">
                    <div class="upload-image-container" id="uploadImageContainer">
                        <img src="https://image2url.com/r2/bucket1/images/1766563557516-9a5da56c-672d-40be-bfb2-4c234bfdc027.png" alt="Upload PDF to make quiz" class="upload-image">
                        <div class="upload-image-overlay">
                            <i class="fas fa-upload"></i> Click to Upload File
                        </div>
                    </div>
                    <h1 class="upload-title">Smart Quiz Extractor</h1>
                    
                    <button class="how-it-works-btn" id="howItWorksBtn">
                        <i class="fas fa-question-circle"></i> How this app works
                    </button>
                    
                    <div class="upload-tabs">
                        <button class="upload-tab active" data-tab="file">
                            <i class="fas fa-file-upload"></i> Upload File
                        </button>
                        <button class="upload-tab" data-tab="paste">
                            <i class="fas fa-paste"></i> Paste Text
                        </button>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div class="upload-tab-content active" id="fileUploadTab">
                        <div class="file-input-wrapper">
                            <input type="file" id="pdfFileInput" class="file-input" accept=".pdf,.txt,.doc,.docx,.rtf">
                            <label for="pdfFileInput" class="file-label">
                                <i class="fas fa-cloud-upload-alt"></i> Choose File (PDF/TXT/DOC)
                            </label>
                        </div>
                        
                        <p class="file-info" id="fileInfo">No file selected. Supports: PDF, TXT, DOC, DOCX, RTF</p>
                        
                        <button class="extract-btn" id="extractBtn" disabled>
                            <span>Extract & Organize Questions</span>
                            <div class="loading" id="loadingIndicator" style="display: none;"></div>
                        </button>
                    </div>
                    
                    <!-- Paste Text Tab -->
                    <div class="upload-tab-content" id="pasteTextTab">
                        <textarea class="paste-textarea" id="pasteTextArea" placeholder="Paste your text here with questions and solutions..."></textarea>
                        
                        <div class="paste-example">
                            <h4><i class="fas fa-lightbulb"></i> Example Format:</h4>
                            <button class="copy-example-btn" id="copyExampleBtn">
                                <i class="fas fa-copy"></i> Copy Example
                            </button>
                            <p>Q.1. What is the capital of France?<br>
                               (a) London (b) Berlin (c) Paris (d) Madrid<br>
                               Sol.1.(c) Paris is the capital of France.</p>
                            <pre id="exampleText">
                            </pre>
                        </div>
                        
                        <button class="extract-btn" id="extractFromPasteBtn">
                            <span>Extract from Pasted Text</span>
                            <div class="loading" id="pasteLoadingIndicator" style="display: none;"></div>
                        </button>
                    </div>
                </section>

                <!-- How It Works Section -->
                <section class="how-it-works-section" id="howItWorksSection">
                    <div class="how-it-works-header">
                        <h2 class="how-it-works-title">How This App Works</h2>
                        <button class="back-btn" id="backFromHowItWorksBtn">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>
                    <div class="how-it-works-content">
                        <h3>     ?</h3>
                        <p>   PDF,   DOC      MCQ        </p>
                        
                        <h3>    :</h3>
                        <ul>
                            <li><strong>  :</strong>   PDF, TXT, DOC    </li>
                            <li><strong>  :</strong>        </li>
                            <li><strong> :</strong>        </li>
                            <li><strong>  :</strong> 25      </li>
                        </ul>
                        
                        <h3>  :</h3>
                        <p>       :</p>
                        <ul>
                            <li>Q.1.  ... (a)  1 (b)  2 (c)  3 (d)  4</li>
                            <li>Sol.1.(c)   ...</li>
                            <li> Question 1: ... A) 1 B) 2 C) 3 D) 4</li>
                            <li>Answer: C. ...</li>
                        </ul>
                        
                        <h3> :</h3>
                        <ul>
                            <li>       </li>
                            <li>   </li>
                            <li>/ </li>
                            <li>  -     </li>
                            <li>     </li>
                        </ul>
                        
                        <h3>   ?</h3>
                        <p>    "Upload File"  "Paste Text"       !</p>
                    </div>
                </section>

                <!-- Library Section -->
                <section class="library-section" id="librarySection">
                    <h2 class="library-title">Your Quiz Library</h2>
                    <div class="library-container" id="libraryContainer">
                        <!-- PDF folders will be added here -->
                    </div>
                    <div class="no-quizzes" id="noQuizzesMessage" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>No quizzes in your library yet</h3>
                        <p>Upload a file or paste text to get started!</p>
                    </div>
                </section>
            </div>

            <!-- Quiz Selection Section -->
            <section class="quiz-selection-section" id="quizSelectionSection">
                <div class="back-to-library">
                    <button class="back-btn" id="backToLibraryBtn">
                        <i class="fas fa-arrow-left"></i> Back to Library
                    </button>
                </div>
                <h2 class="selection-title">Select Your Quiz</h2>
                <div class="subject-filters" id="subjectFilters">
                    <!-- Subject filters will be added here -->
                </div>
                <div class="quiz-cards-container" id="quizCardsContainer">
                    <!-- Quiz cards will be added here -->
                </div>
            </section>

            <!-- Quiz Section -->
            <section class="quiz-section" id="quizSection">
                <!-- Quiz Header -->
                <div class="quiz-header">
                    <div class="quiz-header-info">
                        <div class="question-progress">
                            <i class="fas fa-question-circle"></i>
                            <span id="currentQuestionMobile">1</span>/<span id="totalQuestionsMobile">25</span>
                        </div>
                        <div class="quiz-timer" id="timerMobile">
                            <i class="fas fa-clock"></i>
                            <span id="timerValueMobile">00:00</span>
                        </div>
                        <button class="total-questions-btn" id="questionNavigatorBtnMobile">
                            <i class="fas fa-list-ol"></i> Questions
                        </button>
                    </div>
                </div>
                
                <!-- Main Quiz Content -->
                <div class="quiz-main-content">
                    <div class="question-container">
                        <!-- REMOVED: Red "Question X" text -->
                        
                        <div class="question-text" id="questionText">
                            Question will appear here after extraction.
                        </div>
                        
                        <div class="options-container" id="optionsContainer">
                            <!-- Options will be added here -->
                        </div>
                        
                        <!-- Solution will be automatically shown after answer -->
                        <div class="solution-container" id="solutionContainer" style="display: none;">
                            <div class="solution-title">
                                <i class="fas fa-lightbulb"></i> Solution & Explanation
                            </div>
                            <div class="solution-text" id="solutionText">
                                Solution will appear here when you select an option.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fixed Quiz Controls at Bottom -->
                <div class="quiz-controls">
                    <button class="quiz-btn prev" id="prevBtn" disabled>
                        <i class="fas fa-arrow-left"></i>
                        <span class="btn-text">Previous</span>
                    </button>
                    <button class="quiz-btn submit" id="submitQuizBtn">
                        <i class="fas fa-paper-plane"></i> Submit Quiz
                    </button>
                    <button class="quiz-btn next" id="nextBtn">
                        <span class="btn-text">Next</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <!-- Question Navigator Sidebar -->
                <div class="quiz-sidebar" id="quizSidebar">
                    <h3 class="navigator-title">
                        <i class="fas fa-compass"></i> Questions Navigator
                    </h3>
                    <div class="question-grid" id="questionGrid">
                        <!-- Question bubbles will be added here -->
                    </div>
                    
                    <!-- Statistics -->
                    <div class="sidebar-stats">
                        <div class="stat-item">
                            <span class="stat-label-sidebar">Answered:</span>
                            <span class="stat-value-sidebar" id="answeredCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label-sidebar">Correct:</span>
                            <span class="stat-value-sidebar correct" id="correctCountSidebar">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label-sidebar">Wrong:</span>
                            <span class="stat-value-sidebar incorrect" id="wrongCountSidebar">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label-sidebar">Skipped:</span>
                            <span class="stat-value-sidebar skipped" id="skippedCountSidebar">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection">
                <div class="results-icon" id="resultsIcon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h1 class="results-title">Quiz Completed!</h1>
                <div class="score-display" id="finalScore">0%</div>
                
                <div class="performance-rating" id="performanceRating">
                    <span class="rating-icon"></span>
                    <span class="rating-text" id="ratingText">Loading...</span>
                </div>
                
                <div class="results-stats">
                    <div class="result-stat correct">
                        <span class="value" id="correctCount">0</span>
                        <span class="label">Correct Answers</span>
                    </div>
                    <div class="result-stat incorrect">
                        <span class="value" id="incorrectCount">0</span>
                        <span class="label">Incorrect Answers</span>
                    </div>
                    <div class="result-stat">
                        <span class="value" id="timeTaken">00:00</span>
                        <span class="label">Time Taken</span>
                    </div>
                    <div class="result-stat">
                        <span class="value" id="accuracyRate">0%</span>
                        <span class="label">Accuracy Rate</span>
                    </div>
                </div>
                
                <div class="result-actions">
                    <button class="quiz-btn prev" id="reviewBtn" style="display: none;">
                        <i class="fas fa-redo"></i> Practice Wrong Questions
                    </button>
                    <button class="quiz-btn next" id="backToQuizzesBtn">
                        <i class="fas fa-list"></i> Back to Quizzes
                    </button>
                    <button class="quiz-btn submit" id="downloadBtn">
                        <i class="fas fa-download"></i> Download Results
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Overlay for About & Share -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <h3 class="overlay-title" id="overlayTitle">About PDF2QUIZ</h3>
            <div class="overlay-text" id="overlayText">
                This is an intelligent tool that extracts MCQs from PDFs, text files, and pasted text to create interactive quizzes.
                Upload any PDF/TXT/DOC file or paste text with questions (Q.1, Q.2, etc.) and solutions (Sol.1, Sol.2, etc.).
                The system automatically detects subjects, topics, and organizes questions into
                25-question quizzes with detailed analytics and performance tracking.
            </div>
            <div class="overlay-buttons">
                <button class="quiz-btn prev" id="closeOverlayBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // PDF.js worker configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        // Persistent Storage Management
        const StorageManager = {
            STORAGE_KEY: 'pdfQuizMasterData',
            
            saveData: function(data) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Error saving data:', e);
                    return false;
                }
            },
            
            loadData: function() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : { pdfs: [], version: '1.0' };
                } catch (e) {
                    console.error('Error loading data:', e);
                    return { pdfs: [], version: '1.0' };
                }
            },
            
            addPDF: function(pdfData) {
                const data = this.loadData();
                data.pdfs.push(pdfData);
                return this.saveData(data);
            },
            
            updatePDF: function(pdfId, updatedData) {
                const data = this.loadData();
                const index = data.pdfs.findIndex(pdf => pdf.id === pdfId);
                if (index !== -1) {
                    data.pdfs[index] = { ...data.pdfs[index], ...updatedData };
                    return this.saveData(data);
                }
                return false;
            },
            
            deletePDF: function(pdfId) {
                const data = this.loadData();
                data.pdfs = data.pdfs.filter(pdf => pdf.id !== pdfId);
                return this.saveData(data);
            },
            
            updateQuizPerformance: function(pdfId, quizId, score) {
                const data = this.loadData();
                const pdf = data.pdfs.find(pdf => pdf.id === pdfId);
                if (pdf) {
                    const quiz = pdf.quizzes.find(q => q.id === quizId);
                    if (quiz) {
                        // Store only the best score
                        if (!quiz.bestScore || score > quiz.bestScore) {
                            quiz.bestScore = score;
                            quiz.attempts = (quiz.attempts || 0) + 1;
                            quiz.lastAttempt = new Date().toISOString();
                            return this.saveData(data);
                        } else {
                            // Still increment attempts
                            quiz.attempts = (quiz.attempts || 0) + 1;
                            quiz.lastAttempt = new Date().toISOString();
                            return this.saveData(data);
                        }
                    }
                }
                return false;
            },
            
            getPDFById: function(pdfId) {
                const data = this.loadData();
                return data.pdfs.find(pdf => pdf.id === pdfId);
            },
            
            getAllPDFs: function() {
                const data = this.loadData();
                return data.pdfs || [];
            },
            
            updateQuizName: function(pdfId, quizId, newName) {
                const data = this.loadData();
                const pdf = data.pdfs.find(pdf => pdf.id === pdfId);
                if (pdf) {
                    const quiz = pdf.quizzes.find(q => q.id === quizId);
                    if (quiz) {
                        quiz.name = newName;
                        return this.saveData(data);
                    }
                }
                return false;
            }
        };

        // Enhanced State management with per-question timer
        const state = {
            pdfText: '',
            currentPDF: null,
            currentQuizzes: [],
            subjects: [],
            topics: [],
            currentQuizIndex: 0,
            currentQuestionIndex: 0,
            userAnswers: {},
            quizStarted: false,
            quizCompleted: false,
            timerInterval: null,
            startTime: null,
            elapsedTime: 0,
            totalTime: 0,
            questionTimes: {},
            currentQuestionStartTime: null,
            totalQuestions: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            skippedAnswers: 0,
            extractedData: {
                subjects: [],
                topics: [],
                allQuestions: [],
                topicQuestions: {},
                subjectQuestions: {}
            },
            activeSubject: 'All',
            performanceCharts: {},
            customFolderName: '',
            pendingFile: null,
            pendingText: null,
            currentTab: 'file',
            showSolution: false,
            waitingForNext: false
        };

        // DOM Elements
        const elements = {
            // Custom Confirm Modal Elements
            customConfirmModal: document.getElementById('customConfirmModal'),
            customConfirmTitle: document.getElementById('customConfirmTitle'),
            customConfirmMessage: document.getElementById('customConfirmMessage'),
            customConfirmCancelBtn: document.getElementById('customConfirmCancelBtn'),
            customConfirmOkBtn: document.getElementById('customConfirmOkBtn'),
            
            // Modal Elements
            nameModal: document.getElementById('nameModal'),
            folderNameInput: document.getElementById('folderNameInput'),
            cancelNameBtn: document.getElementById('cancelNameBtn'),
            confirmNameBtn: document.getElementById('confirmNameBtn'),
            
            // Rename Modal
            renameModal: document.getElementById('renameModal'),
            renameInput: document.getElementById('renameInput'),
            cancelRenameBtn: document.getElementById('cancelRenameBtn'),
            confirmRenameBtn: document.getElementById('confirmRenameBtn'),
            
            // Header Elements
            homeLogo: document.getElementById('homeLogo'),
            homeBtn: document.getElementById('homeBtn'),
            drawerToggle: document.getElementById('drawerToggle'),
            sidebar: document.getElementById('sidebar'),
            
            // Upload Elements
            pdfFileInput: document.getElementById('pdfFileInput'),
            extractBtn: document.getElementById('extractBtn'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            fileInfo: document.getElementById('fileInfo'),
            uploadImageContainer: document.getElementById('uploadImageContainer'),
            howItWorksBtn: document.getElementById('howItWorksBtn'),
            howItWorksSection: document.getElementById('howItWorksSection'),
            backFromHowItWorksBtn: document.getElementById('backFromHowItWorksBtn'),
            
            // Tab Elements
            uploadTabs: document.querySelectorAll('.upload-tab'),
            fileUploadTab: document.getElementById('fileUploadTab'),
            pasteTextTab: document.getElementById('pasteTextTab'),
            pasteTextArea: document.getElementById('pasteTextArea'),
            extractFromPasteBtn: document.getElementById('extractFromPasteBtn'),
            pasteLoadingIndicator: document.getElementById('pasteLoadingIndicator'),
            copyExampleBtn: document.getElementById('copyExampleBtn'),
            exampleText: document.getElementById('exampleText'),
            
            // Section Elements
            homeSection: document.getElementById('homeSection'),
            uploadSection: document.getElementById('uploadSection'),
            librarySection: document.getElementById('librarySection'),
            libraryContainer: document.getElementById('libraryContainer'),
            noQuizzesMessage: document.getElementById('noQuizzesMessage'),
            quizSelectionSection: document.getElementById('quizSelectionSection'),
            quizSection: document.getElementById('quizSection'),
            resultsSection: document.getElementById('resultsSection'),
            
            // Quiz Selection Elements
            subjectFilters: document.getElementById('subjectFilters'),
            quizCardsContainer: document.getElementById('quizCardsContainer'),
            backToLibraryBtn: document.getElementById('backToLibraryBtn'),
            
            // Quiz Elements
            quizSidebar: document.getElementById('quizSidebar'),
            questionGrid: document.getElementById('questionGrid'),
            questionNavigatorBtnMobile: document.getElementById('questionNavigatorBtnMobile'),
            
            // Quiz Content Elements
            currentQuestionMobile: document.getElementById('currentQuestionMobile'),
            totalQuestionsMobile: document.getElementById('totalQuestionsMobile'),
            timerMobile: document.getElementById('timerMobile'),
            timerValueMobile: document.getElementById('timerValueMobile'),
            questionText: document.getElementById('questionText'),
            optionsContainer: document.getElementById('optionsContainer'),
            solutionContainer: document.getElementById('solutionContainer'),
            solutionText: document.getElementById('solutionText'),
            
            // Stats Elements
            questionNumberElem: document.getElementById('questionNumber'),
            
            // Sidebar Stats
            answeredCount: document.getElementById('answeredCount'),
            correctCountSidebar: document.getElementById('correctCountSidebar'),
            wrongCountSidebar: document.getElementById('wrongCountSidebar'),
            skippedCountSidebar: document.getElementById('skippedCountSidebar'),
            
            // Control Buttons
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            submitQuizBtn: document.getElementById('submitQuizBtn'),
            
            // Results Elements
            finalScoreElem: document.getElementById('finalScore'),
            correctCountElem: document.getElementById('correctCount'),
            incorrectCountElem: document.getElementById('incorrectCount'),
            timeTakenElem: document.getElementById('timeTaken'),
            accuracyRateElem: document.getElementById('accuracyRate'),
            resultsIcon: document.getElementById('resultsIcon'),
            ratingText: document.getElementById('ratingText'),
            reviewBtn: document.getElementById('reviewBtn'),
            backToQuizzesBtn: document.getElementById('backToQuizzesBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            
            // Sidebar Buttons
            themeBtn: document.getElementById('themeBtn'),
            shareBtn: document.getElementById('shareBtn'),
            aboutBtn: document.getElementById('aboutBtn'),
            
            // Overlay Elements
            overlay: document.getElementById('overlay'),
            overlayTitle: document.getElementById('overlayTitle'),
            overlayText: document.getElementById('overlayText'),
            closeOverlayBtn: document.getElementById('closeOverlayBtn')
        };

        // Custom Confirm Function
        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                elements.customConfirmTitle.textContent = title;
                elements.customConfirmMessage.textContent = message;
                elements.customConfirmModal.style.display = 'flex';
                
                const handleConfirm = () => {
                    elements.customConfirmModal.style.display = 'none';
                    elements.customConfirmOkBtn.removeEventListener('click', handleConfirm);
                    elements.customConfirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    elements.customConfirmModal.style.display = 'none';
                    elements.customConfirmOkBtn.removeEventListener('click', handleConfirm);
                    elements.customConfirmCancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                elements.customConfirmOkBtn.addEventListener('click', handleConfirm);
                elements.customConfirmCancelBtn.addEventListener('click', handleCancel);
            });
        }

        // Custom Alert Function
        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                elements.customConfirmTitle.textContent = title;
                elements.customConfirmMessage.textContent = message;
                elements.customConfirmCancelBtn.style.display = 'none';
                elements.customConfirmModal.style.display = 'flex';
                
                const handleOk = () => {
                    elements.customConfirmModal.style.display = 'none';
                    elements.customConfirmOkBtn.removeEventListener('click', handleOk);
                    elements.customConfirmCancelBtn.style.display = 'block';
                    resolve();
                };
                
                elements.customConfirmOkBtn.addEventListener('click', handleOk);
            });
        }

        // Event Listeners
        elements.homeLogo.addEventListener('click', showHome);
        elements.homeBtn.addEventListener('click', showHome);
        elements.pdfFileInput.addEventListener('change', handleFileSelect);
        elements.extractBtn.addEventListener('click', showNameModal);
        elements.extractFromPasteBtn.addEventListener('click', handlePasteText);
        elements.uploadImageContainer.addEventListener('click', () => {
            if (state.currentTab === 'file') {
                elements.pdfFileInput.click();
            }
        });
        
        // How it works button
        elements.howItWorksBtn.addEventListener('click', showHowItWorks);
        elements.backFromHowItWorksBtn.addEventListener('click', hideHowItWorks);
        
        // Copy example button
        elements.copyExampleBtn.addEventListener('click', copyExampleText);
        
        // Tab listeners
        elements.uploadTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                switchTab(tabName);
            });
        });
        
        // Modal Listeners
        elements.cancelNameBtn.addEventListener('click', cancelNameInput);
        elements.confirmNameBtn.addEventListener('click', confirmNameInput);
        
        // Quiz Listeners
        elements.prevBtn.addEventListener('click', showPreviousQuestion);
        elements.nextBtn.addEventListener('click', showNextQuestion);
        elements.submitQuizBtn.addEventListener('click', submitQuiz);
        elements.reviewBtn.addEventListener('click', reviewWrongQuestions);
        elements.backToQuizzesBtn.addEventListener('click', showQuizSelection);
        elements.backToLibraryBtn.addEventListener('click', showLibrary);
        elements.downloadBtn.addEventListener('click', downloadResults);
        elements.questionNavigatorBtnMobile.addEventListener('click', toggleQuizSidebar);
        
        // Theme and UI Listeners
        elements.themeBtn.addEventListener('click', toggleTheme);
        elements.drawerToggle.addEventListener('click', toggleDrawer);
        elements.shareBtn.addEventListener('click', showShareOverlay);
        elements.aboutBtn.addEventListener('click', showAboutOverlay);
        elements.closeOverlayBtn.addEventListener('click', closeOverlay);

        // Initialize
        init();

        function init() {
            // Check for saved theme
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                elements.themeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
            
            updateFileInfo();
            showHome();
            loadLibrary();
        }

        function showHowItWorks() {
            elements.uploadSection.style.display = 'none';
            elements.librarySection.style.display = 'none';
            elements.howItWorksSection.style.display = 'block';
        }

        function hideHowItWorks() {
            elements.howItWorksSection.style.display = 'none';
            elements.uploadSection.style.display = 'block';
            
            // Show library if there are PDFs
            const pdfs = StorageManager.getAllPDFs();
            if (pdfs.length > 0) {
                elements.librarySection.style.display = 'block';
                elements.noQuizzesMessage.style.display = 'none';
            }
        }

        function switchTab(tabName) {
            state.currentTab = tabName;
            
            // Update tab buttons
            elements.uploadTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update tab content
            if (tabName === 'file') {
                elements.fileUploadTab.classList.add('active');
                elements.pasteTextTab.classList.remove('active');
            } else if (tabName === 'paste') {
                elements.pasteTextTab.classList.add('active');
                elements.fileUploadTab.classList.remove('active');
            }
        }

        function copyExampleText() {
            const exampleText = elements.exampleText.textContent;
            navigator.clipboard.writeText(exampleText).then(() => {
                showCustomAlert('Copied!', 'Example text has been copied to clipboard!');
            });
        }

        function showHome() {
            document.body.classList.remove('quiz-active');
            elements.homeSection.style.display = 'block';
            elements.quizSelectionSection.style.display = 'none';
            elements.quizSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            elements.howItWorksSection.style.display = 'none';
            
            // Show upload section
            elements.uploadSection.style.display = 'block';
            
            // Show library if there are PDFs
            const pdfs = StorageManager.getAllPDFs();
            if (pdfs.length > 0) {
                elements.librarySection.style.display = 'block';
                elements.noQuizzesMessage.style.display = 'none';
            } else {
                elements.librarySection.style.display = 'none';
                elements.noQuizzesMessage.style.display = 'block';
            }
        }

        function showLibrary() {
            loadLibrary();
            showHome();
        }

        function loadLibrary() {
            const pdfs = StorageManager.getAllPDFs();
            elements.libraryContainer.innerHTML = '';
            
            if (pdfs.length === 0) {
                elements.noQuizzesMessage.style.display = 'block';
                elements.librarySection.style.display = 'none';
                return;
            }
            
            elements.noQuizzesMessage.style.display = 'none';
            elements.librarySection.style.display = 'block';
            
            pdfs.forEach(pdf => {
                const folder = document.createElement('div');
                folder.className = 'pdf-folder';
                folder.dataset.pdfId = pdf.id;
                
                // Calculate total quizzes
                const totalQuizzes = pdf.quizzes.length;
                const totalQuestions = pdf.quizzes.reduce((sum, quiz) => sum + quiz.questions.length, 0);
                
                // Calculate average performance
                const quizzesWithScores = pdf.quizzes.filter(q => q.bestScore !== undefined);
                const avgScore = quizzesWithScores.length > 0 
                    ? Math.round(quizzesWithScores.reduce((sum, q) => sum + q.bestScore, 0) / quizzesWithScores.length)
                    : 0;
                
                folder.innerHTML = `
                    <div class="folder-header">
                        <div class="folder-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="folder-actions">
                            <button class="folder-action-btn delete-pdf" title="Delete PDF">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="folder-name">${pdf.customName || pdf.name}</h3>
                    <div class="folder-quiz-number">
                        <i class="fas fa-list-ol"></i> Contains ${totalQuizzes} Quiz${totalQuizzes !== 1 ? 'zes' : ''}
                    </div>
                    <p style="color: var(--gray); margin-bottom: 0.8rem; font-size: 0.9rem;">
                        <i class="fas fa-calendar"></i> Added: ${new Date(pdf.uploadedAt).toLocaleDateString()}
                    </p>
                    <div class="folder-meta">
                        <div class="meta-item">
                            <span class="meta-value">${totalQuizzes}</span>
                            <span class="meta-label">Quizzes</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-value">${totalQuestions}</span>
                            <span class="meta-label">Questions</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-value">${avgScore}%</span>
                            <span class="meta-label">Avg Score</span>
                        </div>
                    </div>
                    <div class="performance-chart">
                        <canvas id="chart-${pdf.id}" width="300" height="100"></canvas>
                    </div>
                `;
                
                folder.addEventListener('click', (e) => {
                    if (!e.target.closest('.folder-action-btn')) {
                        openPDF(pdf.id);
                    }
                });
                
                // Add delete button event
                const deleteBtn = folder.querySelector('.delete-pdf');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showCustomConfirm('Delete Quiz Set', `Are you sure you want to delete "${pdf.customName || pdf.name}" and all its quizzes?`)
                        .then((confirmed) => {
                            if (confirmed) {
                                StorageManager.deletePDF(pdf.id);
                                loadLibrary();
                            }
                        });
                });
                
                elements.libraryContainer.appendChild(folder);
                
                // Create performance chart
                setTimeout(() => {
                    createPerformanceChart(pdf);
                }, 100);
            });
        }

        function createPerformanceChart(pdf) {
            const canvasId = `chart-${pdf.id}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Prepare data for chart
            const quizNames = pdf.quizzes.map((q, i) => `Quiz ${i + 1}`);
            const quizScores = pdf.quizzes.map(q => q.bestScore || 0);
            const quizColors = quizScores.map(score => {
                if (score >= 80) return '#06D6A0';
                if (score >= 60) return '#FFD166';
                if (score >= 40) return '#FF9A3D';
                return '#EF476F';
            });
            
            // Destroy existing chart if it exists
            if (state.performanceCharts[pdf.id]) {
                state.performanceCharts[pdf.id].destroy();
            }
            
            // Create new chart
            state.performanceCharts[pdf.id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: quizNames,
                    datasets: [{
                        label: 'Best Score (%)',
                        data: quizScores,
                        backgroundColor: quizColors,
                        borderColor: quizColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 8
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 8
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function openPDF(pdfId) {
            const pdf = StorageManager.getPDFById(pdfId);
            if (!pdf) return;
            
            state.currentPDF = pdf;
            state.currentQuizzes = pdf.quizzes;
            
            // Extract subjects from quizzes
            const subjectsSet = new Set(['All']);
            pdf.quizzes.forEach(quiz => {
                if (quiz.subject) subjectsSet.add(quiz.subject);
            });
            state.subjects = Array.from(subjectsSet);
            
            showQuizSelection();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const validExtensions = ['.pdf', '.txt', '.doc', '.docx', '.rtf'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validExtensions.includes(fileExt)) {
                    showCustomAlert('Invalid File', 'Please select a PDF, TXT, DOC, DOCX, or RTF file.');
                    elements.pdfFileInput.value = '';
                    updateFileInfo();
                    elements.extractBtn.disabled = true;
                    return;
                }
                
                state.pendingFile = file;
                updateFileInfo(file);
                elements.extractBtn.disabled = false;
            } else {
                updateFileInfo();
                elements.extractBtn.disabled = true;
            }
        }

        function handlePasteText() {
            const text = elements.pasteTextArea.value.trim();
            if (!text) {
                showCustomAlert('Empty Text', 'Please paste some text containing questions and solutions.');
                return;
            }
            
            state.pendingText = text;
            showNameModal();
        }

        function showNameModal() {
            if (!state.pendingFile && !state.pendingText) return;
            
            // Set default name
            let defaultName = '';
            if (state.pendingFile) {
                defaultName = state.pendingFile.name.replace(/\.[^/.]+$/, "");
            } else {
                defaultName = "Text Quiz " + new Date().toLocaleDateString();
            }
            elements.folderNameInput.value = defaultName;
            elements.nameModal.style.display = 'flex';
        }

        function cancelNameInput() {
            elements.nameModal.style.display = 'none';
            elements.pdfFileInput.value = '';
            state.pendingFile = null;
            state.pendingText = null;
            updateFileInfo();
            elements.extractBtn.disabled = true;
        }

        function confirmNameInput() {
            const folderName = elements.folderNameInput.value.trim();
            if (!folderName) {
                showCustomAlert('Folder Name Required', 'Please enter a folder name.');
                return;
            }
            
            state.customFolderName = folderName;
            elements.nameModal.style.display = 'none';
            
            if (state.pendingFile) {
                extractQuestionsFromFile();
            } else if (state.pendingText) {
                extractQuestionsFromText(state.pendingText);
            }
        }

        function updateFileInfo(file = null) {
            if (file) {
                elements.fileInfo.textContent = ` ${file.name}  ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                elements.fileInfo.style.color = 'var(--primary)';
            } else {
                elements.fileInfo.textContent = ' No file selected. Supports: PDF, TXT, DOC, DOCX, RTF';
                elements.fileInfo.style.color = 'var(--gray)';
            }
        }

        async function extractQuestionsFromFile() {
            if (!state.pendingFile) return;
            
            const file = state.pendingFile;
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            // Show loading
            elements.extractBtn.disabled = true;
            elements.loadingIndicator.style.display = 'inline-block';
            elements.extractBtn.innerHTML = '<span>Processing File...</span>';
            
            try {
                let fullText = '';
                
                if (fileExt === '.pdf') {
                    // Read PDF file
                    const arrayBuffer = await file.arrayBuffer();
                    const typedArray = new Uint8Array(arrayBuffer);
                    
                    // Load PDF document
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;
                    
                    // Extract text from all pages
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        
                        let pageText = '';
                        let lastY = null;
                        
                        textContent.items.forEach((item, index) => {
                            if (lastY !== null && Math.abs(item.transform[5] - lastY) > 3) {
                                pageText += '\n';
                            }
                            pageText += item.str + ' ';
                            lastY = item.transform[5];
                        });
                        
                        fullText += pageText + '\n\n';
                    }
                } else {
                    // Read text-based files
                    const text = await file.text();
                    fullText = text;
                }
                
                state.pdfText = fullText;
                
                // Parse and organize questions
                await parseAndOrganizeQuestionsEnhanced(fullText);
                
                // Create quizzes
                const quizzes = createQuizzesFromQuestions(state.extractedData.allQuestions);
                
                // Create PDF data object
                const pdfData = {
                    id: 'quiz_' + Date.now(),
                    name: file.name,
                    customName: state.customFolderName,
                    size: file.size,
                    uploadedAt: new Date().toISOString(),
                    quizzes: quizzes,
                    originalText: fullText.substring(0, 10000)
                };
                
                // Save to storage
                StorageManager.addPDF(pdfData);
                
                // Update UI
                showHome();
                loadLibrary();
                
                // Clear inputs
                elements.pdfFileInput.value = '';
                state.pendingFile = null;
                updateFileInfo();
                
                showCustomAlert('Success', `Successfully extracted ${state.extractedData.allQuestions.length} questions and created ${quizzes.length} quizzes!`);
                
            } catch (error) {
                console.error('Error extracting file:', error);
                showCustomAlert('Error', 'Error processing file. Please ensure the file contains selectable text and try again.');
            } finally {
                // Hide loading
                elements.extractBtn.disabled = false;
                elements.loadingIndicator.style.display = 'none';
                elements.extractBtn.innerHTML = '<span>Extract & Organize Questions</span>';
            }
        }

        async function extractQuestionsFromText(text) {
            // Show loading
            elements.extractFromPasteBtn.disabled = true;
            elements.pasteLoadingIndicator.style.display = 'inline-block';
            elements.extractFromPasteBtn.innerHTML = '<span>Processing Text...</span>';
            
            try {
                state.pdfText = text;
                
                // Parse and organize questions
                await parseAndOrganizeQuestionsEnhanced(text);
                
                // Create quizzes
                const quizzes = createQuizzesFromQuestions(state.extractedData.allQuestions);
                
                // Create PDF data object
                const pdfData = {
                    id: 'text_' + Date.now(),
                    name: 'Pasted Text',
                    customName: state.customFolderName,
                    size: text.length,
                    uploadedAt: new Date().toISOString(),
                    quizzes: quizzes,
                    originalText: text.substring(0, 10000)
                };
                
                // Save to storage
                StorageManager.addPDF(pdfData);
                
                // Update UI
                showHome();
                loadLibrary();
                
                // Clear textarea
                elements.pasteTextArea.value = '';
                state.pendingText = null;
                
                showCustomAlert('Success', `Successfully extracted ${state.extractedData.allQuestions.length} questions and created ${quizzes.length} quizzes!`);
                
            } catch (error) {
                console.error('Error extracting text:', error);
                showCustomAlert('Error', 'Error processing text. Please check the format and try again.');
            } finally {
                // Hide loading
                elements.extractFromPasteBtn.disabled = false;
                elements.pasteLoadingIndicator.style.display = 'none';
                elements.extractFromPasteBtn.innerHTML = '<span>Extract from Pasted Text</span>';
            }
        }

        async function parseAndOrganizeQuestionsEnhanced(text) {
            state.extractedData = {
                subjects: [],
                topics: [],
                allQuestions: [],
                topicQuestions: {},
                subjectQuestions: {}
            };
            
            // Enhanced regex patterns for all formats
            const questionPatterns = [
                // Standard formats
                /Q\.\s*(\d+)[\.:)\-\]\s*(.*?)(?=Q\.\s*\d+[\.:)\-\]|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                /Q\s*(\d+)[\.:)\-\]\s*(.*?)(?=Q\s*\d+[\.:)\-\]|Sol\s*\d+[\.:)\-\]|$)/gis,
                /Question\s*(\d+)[\.:)\-\]\s*(.*?)(?=Question\s*\d+[\.:)\-\]|Solution\s*\d+[\.:)\-\]|$)/gis,
                /Que\.\s*(\d+)[\.:)\-\]\s*(.*?)(?=Que\.\s*\d+[\.:)\-\]|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                /Question\s*No\.\s*(\d+)[\.:)\-\]\s*(.*?)(?=Question\s*No\.\s*\d+[\.:)\-\]|Solution\s*No\.\s*\d+[\.:)\-\]|$)/gis,
                /QUESTION:\s*(\d+)[\.:)\-\]\s*(.*?)(?=QUESTION:\s*\d+[\.:)\-\]|SOLUTION:\s*\d+[\.:)\-\]|$)/gis,
                /QUES\s*(\d+)[\.:)\-\]\s*(.*?)(?=QUES\s*\d+[\.:)\-\]|SOL\s*\d+[\.:)\-\]|$)/gis,
                
                // Additional formats from the list
                /Ques?\.?\s*(\d+)[\.:)\-\]\s*(.*?)(?=Ques?\.?\s*\d+[\.:)\-\]|Sol\.?\s*\d+[\.:)\-\]|$)/gis,
                /Q-(\d+)[\.:)\-\]\s*(.*?)(?=Q-\d+[\.:)\-\]|Sol-\d+[\.:)\-\]|$)/gis,
                /Ques?\.?\s*(\d+)\s*-\s*(.*?)(?=Ques?\.?\s*\d+\s*-|Sol\.?\s*\d+\s*-|$)/gis,
                /Query\s*(\d+):\s*(.*?)(?=Query\s*\d+:|Response\s*\d+:|$)/gis,
                /Problem\s*(\d+)\.\s*(.*?)(?=Problem\s*\d+\.|Answer\s*\d+\.|$)/gis,
                /Item\s*(\d+):\s*(.*?)(?=Item\s*\d+:|Resolution\s*\d+:|$)/gis,
                
                // Simple numbered formats
                /(\d+)\.\s*(.*?)(?=\d+\.\s*|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                /(\d+)\)\s*(.*?)(?=\d+\)\s*|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                /\((\d+)\)\s*(.*?)(?=\(\d+\)\s*|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                /\[(\d+)\]\s*(.*?)(?=\[\d+\]\s*|Sol\.\s*\d+[\.:)\-\]|$)/gis,
                
                // Hindi formats
                /\s*(\d+)[\.:)\-\]\s*(.*?)(?=\s*\d+[\.:)\-\]|\s*\d+[\.:)\-\]|$)/gis,
                /\.\s*(\d+)[\.:)\-\]\s*(.*?)(?=\.\s*\d+[\.:)\-\]|\.\s*\d+[\.:)\-\]|$)/gis
            ];
            
            // Solution patterns
            const solutionPatterns = [
                /Sol\.\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Sol\.\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                /Solution\.\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Solution\.\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                /SOL\.\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=SOL\.\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                /Ans\.?\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Ans\.?\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                /Answer:\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Answer:\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                /Explanation\.\s*(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Explanation\.\s*\d+[\.:)\-\]|Q\.\s*\d+[\.:)\-\]|$)/gis,
                
                // Additional formats
                /Sol-(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Sol-\d+[\.:)\-\]|Q-\d+[\.:)\-\]|$)/gis,
                /Key-(\d+)[\.:)\-\]\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Key-\d+[\.:)\-\]|Q-\d+[\.:)\-\]|$)/gis,
                /Correct Answer\s*(\d+):\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Correct Answer\s*\d+:|Ques?\s*\d+:|$)/gis,
                /Response\s*(\d+):\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Response\s*\d+:|Query\s*\d+:|$)/gis,
                /Resolution\s*(\d+):\s*(?:\(?([a-dA-D1-4])\)?)?\s*(.*?)(?=Resolution\s*\d+:|Item\s*\d+:|$)/gis
            ];
            
            // Answer patterns within solution text
            const answerPatterns = [
                /Ans:\s*([a-dA-D1-4])/gi,
                /Answer\s*-\s*([a-dA-D1-4])/gi,
                /Correct\s*Answer:\s*([a-dA-D1-4])/gi,
                /Correct\s*option\s*is\s*([a-dA-D1-4])/gi,
                /Option\s*\(([a-dA-D1-4])\)\s*is\s*correct/gi,
                /[\(\[{]?([a-dA-D1-4])[\)\]}]?\s*is.*?correct/gi,
                /Key:\s*([a-dA-D1-4])/gi
            ];
            
            // Extract all questions
            const questionsMap = new Map();
            
            // Try each question pattern
            for (const pattern of questionPatterns) {
                pattern.lastIndex = 0;
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const questionNum = parseInt(match[1].replace(/[^0-9]/g, ''));
                    let questionText = match[2].trim();
                    
                    // Skip if we already have this question
                    if (questionsMap.has(questionNum)) continue;
                    
                    // Clean up question text
                    questionText = questionText.replace(/\s+/g, ' ').replace(/\n/g, ' ');
                    
                    // Extract options using multiple patterns
                    const options = extractOptionsFromText(questionText);
                    
                    // Remove options from question text for cleaner display
                    let cleanQuestionText = questionText;
                    if (options.length > 0) {
                        // Remove common option patterns from question text
                        cleanQuestionText = cleanQuestionText
                            .replace(/\([a-dA-D1-4]\)\s*[^\.]*?(?=\([a-dA-D1-4]\)|$)/g, '')
                            .replace(/[a-dA-D1-4]\.\s*[^\.]*?(?=[a-dA-D1-4]\.|$)/g, '')
                            .replace(/[a-dA-D1-4]\s*[\)\-]\s*[^\.]*?(?=[a-dA-D1-4]\s*[\)\-]|$)/g, '')
                            .trim();
                    }
                    
                    // Ensure clean text isn't empty
                    if (!cleanQuestionText || cleanQuestionText.length < 5) {
                        cleanQuestionText = questionText.substring(0, 200) + (questionText.length > 200 ? '...' : '');
                    }
                    
                    questionsMap.set(questionNum, {
                        id: questionNum,
                        text: cleanQuestionText,
                        originalText: questionText,
                        options: options,
                        correctAnswer: null,
                        solution: null,
                        topic: 'General',
                        subject: 'General'
                    });
                }
            }
            
            // Extract solutions and answers
            for (const pattern of solutionPatterns) {
                pattern.lastIndex = 0;
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const questionNum = parseInt(match[1].replace(/[^0-9]/g, ''));
                    let correctAnswer = match[2] ? match[2].trim().toLowerCase() : null;
                    const solutionText = match[3] ? match[3].trim() : '';
                    
                    if (questionsMap.has(questionNum)) {
                        const question = questionsMap.get(questionNum);
                        question.solution = solutionText;
                        question.solutionNumber = questionNum;
                        
                        // If answer is in solution text, extract it
                        if (!correctAnswer && solutionText) {
                            for (const answerPattern of answerPatterns) {
                                answerPattern.lastIndex = 0;
                                const answerMatch = answerPattern.exec(solutionText);
                                if (answerMatch) {
                                    correctAnswer = answerMatch[1].toLowerCase();
                                    break;
                                }
                            }
                        }
                        
                        // Normalize answer format
                        if (correctAnswer) {
                            // Convert numbers and special characters to letters
                            const answerMap = {
                                '1': 'a', '2': 'b', '3': 'c', '4': 'd',
                                '': 'a', '': 'b', '': 'c', '': 'd'
                            };
                            
                            correctAnswer = answerMap[correctAnswer] || correctAnswer;
                            question.correctAnswer = correctAnswer;
                        }
                    }
                }
            }
            
            // Convert map to array and sort
            state.extractedData.allQuestions = Array.from(questionsMap.values())
                .filter(q => q.text.length > 3) // Filter out very short questions
                .sort((a, b) => a.id - b.id);
            
            // Auto-detect subjects based on keywords
            const subjectKeywords = {
                'Mathematics': ['math', 'algebra', 'geometry', 'calculus', 'equation', 'formula', 'triangle', 'circle', 'angle', 'integral', 'derivative', 'solve', 'function'],
                'Physics': ['physics', 'force', 'energy', 'velocity', 'acceleration', 'gravity', 'motion', 'electric', 'magnetic', 'wave', 'light', 'sound', 'heat'],
                'Chemistry': ['chemistry', 'atom', 'molecule', 'chemical', 'reaction', 'element', 'compound', 'periodic', 'bond', 'acid', 'base', 'organic'],
                'Biology': ['biology', 'cell', 'organism', 'dna', 'genetic', 'evolution', 'photosynthesis', 'respiration', 'plant', 'animal', 'human'],
                'History': ['history', 'historical', 'century', 'war', 'king', 'empire', 'revolution', 'ancient', 'medieval', 'battle', 'civilization'],
                'Geography': ['geography', 'map', 'country', 'river', 'mountain', 'climate', 'population', 'continent', 'ocean', 'earth', 'weather'],
                'English': ['english', 'grammar', 'vocabulary', 'sentence', 'paragraph', 'essay', 'literature', 'poem', 'word', 'meaning', 'synonym'],
                'General Knowledge': ['general knowledge', 'gk', 'current affairs', 'static', 'awareness', 'world', 'famous', 'important']
            };
            
            state.extractedData.allQuestions.forEach(question => {
                const questionText = (question.text + ' ' + question.originalText).toLowerCase();
                let detectedSubject = 'General Knowledge';
                let maxMatches = 0;
                
                for (const [subject, keywords] of Object.entries(subjectKeywords)) {
                    const matches = keywords.filter(keyword => 
                        questionText.includes(keyword.toLowerCase())
                    ).length;
                    
                    if (matches > maxMatches) {
                        maxMatches = matches;
                        detectedSubject = subject;
                    }
                }
                
                question.subject = detectedSubject;
            });
            
            // Group by subject for statistics
            state.extractedData.allQuestions.forEach(question => {
                const subject = question.subject;
                if (!state.extractedData.subjectQuestions[subject]) {
                    state.extractedData.subjectQuestions[subject] = [];
                }
                state.extractedData.subjectQuestions[subject].push(question);
            });
            
            state.extractedData.subjects = Object.keys(state.extractedData.subjectQuestions);
        }

        function extractOptionsFromText(text) {
            const options = [];
            const optionPatterns = [
                // Standard patterns
                /\(([a-dA-D])\)\s*(.*?)(?=\([a-dA-D]\)|$)/g,
                /([a-dA-D])\.\s*(.*?)(?=[a-dA-D]\.|$)/g,
                /([a-dA-D])\s*[\)\-]\s*(.*?)(?=[a-dA-D]\s*[\)\-]|$)/g,
                
                // Number patterns
                /\((\d)\)\s*(.*?)(?=\(\d\)|$)/g,
                /(\d)\.\s*(.*?)(?=\d\.|$)/g,
                /(\d)\)\s*(.*?)(?=\d\)|$)/g,
                
                // Special characters
                /\(([])\)\s*(.*?)(?=\([]\)|$)/g,
                /([])\.\s*(.*?)(?=[]\.|$)/g,
                
                // Uppercase with colon
                /([A-D]):\s*(.*?)(?=[A-D]:|$)/g,
                
                // With brackets
                /\[([a-dA-D])\]\s*(.*?)(?=\[[a-dA-D]\]|$)/g,
                
                // Hindi patterns
                /\(([-])\)\s*(.*?)(?=\([-]\)|$)/g,
                /([-])\.\s*(.*?)(?=[-]\.|$)/g
            ];
            
            for (const pattern of optionPatterns) {
                pattern.lastIndex = 0;
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    let optionId = match[1].toLowerCase();
                    const optionText = match[2].trim();
                    
                    // Map different option formats to a-d
                    const optionMap = {
                        '1': 'a', '2': 'b', '3': 'c', '4': 'd',
                        '': 'a', '': 'b', '': 'c', '': 'd',
                        '': 'a', '': 'b', '': 'c', '': 'd'
                    };
                    
                    optionId = optionMap[optionId] || optionId;
                    
                    // Only add if we have a valid option ID (a-d)
                    if (['a', 'b', 'c', 'd'].includes(optionId)) {
                        // Check if we already have this option
                        if (!options.some(opt => opt.id === optionId)) {
                            options.push({
                                id: optionId,
                                text: optionText,
                                originalId: match[1]
                            });
                        }
                    }
                }
                
                // If we found options, stop looking
                if (options.length > 0) {
                    break;
                }
            }
            
            // If no options found with patterns, try to extract inline options
            if (options.length === 0) {
                const inlinePattern = /\(([a-dA-D1-4])\)\s*([^\(\)]+?)(?=\([a-dA-D1-4]\)|$)/g;
                inlinePattern.lastIndex = 0;
                let match;
                
                while ((match = inlinePattern.exec(text)) !== null) {
                    let optionId = match[1].toLowerCase();
                    let optionText = match[2].trim();
                    
                    // Map numbers to letters
                    const optionMap = {
                        '1': 'a', '2': 'b', '3': 'c', '4': 'd'
                    };
                    
                    optionId = optionMap[optionId] || optionId;
                    
                    if (['a', 'b', 'c', 'd'].includes(optionId)) {
                        if (!options.some(opt => opt.id === optionId)) {
                            options.push({
                                id: optionId,
                                text: optionText,
                                originalId: match[1]
                            });
                        }
                    }
                }
            }
            
            // Sort options by id (a, b, c, d)
            return options.sort((a, b) => a.id.localeCompare(b.id));
        }

        function createQuizzesFromQuestions(questions) {
            const quizzes = [];
            const chunkSize = 25;
            
            // Group questions by subject first
            const questionsBySubject = {};
            questions.forEach(q => {
                if (!questionsBySubject[q.subject]) {
                    questionsBySubject[q.subject] = [];
                }
                questionsBySubject[q.subject].push(q);
            });
            
            // Create quizzes from each subject group
            Object.entries(questionsBySubject).forEach(([subject, subjectQuestions]) => {
                // Split into chunks of 25
                for (let i = 0; i < subjectQuestions.length; i += chunkSize) {
                    const chunk = subjectQuestions.slice(i, i + chunkSize);
                    const quizNumber = Math.floor(i / chunkSize) + 1;
                    
                    quizzes.push({
                        id: `quiz_${Date.now()}_${subject}_${quizNumber}`,
                        name: `${state.customFolderName || 'Quiz'} ${quizNumber}`,
                        subject: subject,
                        questions: chunk,
                        totalQuestions: chunk.length,
                        bestScore: 0,
                        attempts: 0,
                        lastAttempt: null
                    });
                }
            });
            
            // If we have less than chunkSize questions, create one quiz
            if (quizzes.length === 0 && questions.length > 0) {
                quizzes.push({
                    id: `quiz_${Date.now()}_1`,
                    name: `${state.customFolderName || 'Quiz'} 1`,
                    subject: 'General Knowledge',
                    questions: questions.slice(0, chunkSize),
                    totalQuestions: Math.min(questions.length, chunkSize),
                    bestScore: 0,
                    attempts: 0,
                    lastAttempt: null
                });
            }
            
            return quizzes;
        }

        function showQuizSelection() {
            document.body.classList.remove('quiz-active');
            elements.homeSection.style.display = 'none';
            elements.quizSection.style.display = 'none';
            elements.resultsSection.style.display = 'none';
            elements.quizSelectionSection.style.display = 'block';
            
            updateSubjectFilters();
            updateQuizCards();
        }

        function updateSubjectFilters() {
            elements.subjectFilters.innerHTML = '';
            
            state.subjects.forEach(subject => {
                const filter = document.createElement('button');
                filter.className = `subject-filter ${subject === state.activeSubject ? 'active' : ''}`;
                filter.textContent = subject;
                filter.addEventListener('click', () => {
                    state.activeSubject = subject;
                    updateSubjectFilters();
                    updateQuizCards();
                });
                elements.subjectFilters.appendChild(filter);
            });
        }

        function updateQuizCards() {
            elements.quizCardsContainer.innerHTML = '';
            
            const filteredQuizzes = state.activeSubject === 'All' 
                ? state.currentQuizzes 
                : state.currentQuizzes.filter(q => q.subject === state.activeSubject);
            
            if (filteredQuizzes.length === 0) {
                elements.quizCardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <i class="fas fa-search fa-2x" style="margin-bottom: 1rem;"></i>
                        <h3 style="margin-bottom: 0.8rem;">No quizzes found for "${state.activeSubject}"</h3>
                        <p>Try selecting a different subject.</p>
                    </div>
                `;
                return;
            }
            
            filteredQuizzes.forEach((quiz, index) => {
                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.dataset.quizIndex = index;
                
                const bestScore = quiz.bestScore || 0;
                const attempts = quiz.attempts || 0;
                
                card.innerHTML = `
                    <div class="quiz-card-header">
                        <div class="quiz-number">${quiz.name}</div>
                        <div class="quiz-badge">${quiz.subject}</div>
                    </div>
                    <p style="color: var(--gray); margin-bottom: 0.8rem; font-size: 0.9rem;">
                        <i class="fas fa-question-circle"></i> ${quiz.totalQuestions} Questions
                    </p>
                    <div class="quiz-performance">
                        <div class="performance-score">${bestScore}%</div>
                        <div class="performance-label">Best Score (${attempts} attempts)</div>
                    </div>
                    <div class="quiz-meta">
                        <div class="meta-item">
                            <span class="meta-value">${quiz.totalQuestions}</span>
                            <span class="meta-label">Questions</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-value">25</span>
                            <span class="meta-label">Max per Quiz</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-value">${attempts}</span>
                            <span class="meta-label">Attempts</span>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    startQuiz(index);
                });
                
                elements.quizCardsContainer.appendChild(card);
            });
        }

        function startQuiz(quizIndex) {
            if (quizIndex < 0 || quizIndex >= state.currentQuizzes.length) return;
            
            state.currentQuizIndex = quizIndex;
            state.currentQuestionIndex = 0;
            state.userAnswers = {};
            state.quizStarted = true;
            state.quizCompleted = false;
            state.elapsedTime = 0;
            state.totalTime = 0;
            state.questionTimes = {};
            state.correctAnswers = 0;
            state.incorrectAnswers = 0;
            state.skippedAnswers = 0;
            state.waitingForNext = false;
            state.showSolution = false;
            
            // Add quiz-active class to body
            document.body.classList.add('quiz-active');
            
            // Update UI
            elements.quizSelectionSection.style.display = 'none';
            elements.quizSection.style.display = 'block';
            elements.resultsSection.style.display = 'none';
            
            // Update quiz info
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            elements.totalQuestionsMobile.textContent = currentQuiz.questions.length;
            
            // Display first question
            displayCurrentQuestion();
            updateQuestionGrid();
            updateSidebarStats();
        }

        function updateQuestionGrid() {
            elements.questionGrid.innerHTML = '';
            
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            if (!currentQuiz) return;
            
            currentQuiz.questions.forEach((question, index) => {
                const bubble = document.createElement('div');
                bubble.className = 'question-bubble';
                
                if (index === state.currentQuestionIndex) {
                    bubble.classList.add('active');
                }
                
                const questionId = question.id;
                const userAnswer = state.userAnswers[questionId];
                
                if (userAnswer !== undefined) {
                    if (userAnswer === question.correctAnswer) {
                        bubble.classList.add('answered');
                    } else {
                        bubble.classList.add('wrong');
                    }
                } else {
                    bubble.classList.add('skipped');
                }
                
                bubble.textContent = index + 1;
                bubble.title = `Question ${index + 1}`;
                
                bubble.addEventListener('click', () => {
                    state.currentQuestionIndex = index;
                    displayCurrentQuestion();
                    updateQuestionGrid();
                    elements.quizSidebar.classList.remove('show');
                });
                
                elements.questionGrid.appendChild(bubble);
            });
        }

        function updateSidebarStats() {
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            if (!currentQuiz) return;
            
            let answered = 0;
            let correct = 0;
            let wrong = 0;
            let skipped = 0;
            
            currentQuiz.questions.forEach(question => {
                const userAnswer = state.userAnswers[question.id];
                if (userAnswer !== undefined) {
                    answered++;
                    if (userAnswer === question.correctAnswer) {
                        correct++;
                    } else {
                        wrong++;
                    }
                } else {
                    skipped++;
                }
            });
            
            elements.answeredCount.textContent = answered;
            elements.correctCountSidebar.textContent = correct;
            elements.wrongCountSidebar.textContent = wrong;
            elements.skippedCountSidebar.textContent = skipped;
        }

        function displayCurrentQuestion() {
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            if (!currentQuiz || state.currentQuestionIndex >= currentQuiz.questions.length) return;
            
            const question = currentQuiz.questions[state.currentQuestionIndex];
            
            // Stop previous question timer if exists
            if (state.currentQuestionStartTime) {
                const timeSpent = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                state.questionTimes[state.currentQuestionIndex] = timeSpent;
                state.totalTime += timeSpent;
            }
            
            // Start timer for current question
            state.currentQuestionStartTime = Date.now();
            startQuestionTimer();
            
            // Update question display
            elements.currentQuestionMobile.textContent = state.currentQuestionIndex + 1;
            elements.questionText.textContent = question.text;
            
            // Clear and create options
            elements.optionsContainer.innerHTML = '';
            elements.solutionContainer.style.display = 'none';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach(option => {
                    const optionElem = document.createElement('div');
                    optionElem.className = 'option';
                    
                    const questionId = question.id;
                    const userAnswer = state.userAnswers[questionId];
                    
                    // Check if this option is selected
                    if (userAnswer === option.id) {
                        optionElem.classList.add('selected');
                    }
                    
                    // Check if we should show correct/incorrect (only if answered)
                    if (userAnswer !== undefined && question.correctAnswer) {
                        if (option.id === question.correctAnswer) {
                            optionElem.classList.add('correct');
                        } else if (option.id === userAnswer && userAnswer !== question.correctAnswer) {
                            optionElem.classList.add('incorrect');
                        }
                    }
                    
                    optionElem.innerHTML = `
                        <div class="option-letter">${option.originalId ? option.originalId.toUpperCase() : option.id.toUpperCase()}</div>
                        <div class="option-text">${option.text}</div>
                    `;
                    
                    optionElem.addEventListener('click', () => {
                        if (state.userAnswers[questionId] === undefined) {
                            selectOption(questionId, option.id);
                        }
                    });
                    elements.optionsContainer.appendChild(optionElem);
                });
            } else {
                elements.optionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--warning);">
                        <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 0.8rem;"></i>
                        <h3 style="margin-bottom: 0.6rem;">No Options Available</h3>
                        <p>This question doesn't have multiple choice options.</p>
                    </div>
                `;
            }
            
            // Update navigation buttons
            elements.prevBtn.disabled = state.currentQuestionIndex === 0;
            const isLastQuestion = state.currentQuestionIndex === currentQuiz.questions.length - 1;
            elements.nextBtn.disabled = isLastQuestion && state.userAnswers[question.id] === undefined;
            
            // Show solution if already answered
            if (state.userAnswers[question.id] !== undefined) {
                showSolution(question);
            }
            
            // Update stats
            updateSidebarStats();
        }

        function startQuestionTimer() {
            // Clear any existing timer
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
            }
            
            // Reset timer display
            elements.timerValueMobile.textContent = '00:00';
            
            // Start new timer
            state.timerInterval = setInterval(() => {
                const currentTime = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                const minutes = Math.floor(currentTime / 60);
                const seconds = currentTime % 60;
                
                elements.timerValueMobile.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Add warning after 60 seconds
                if (currentTime > 60) {
                    elements.timerMobile.style.background = 'rgba(255, 154, 61, 0.3)';
                }
            }, 1000);
        }

        function selectOption(questionId, optionId) {
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            const question = currentQuiz.questions.find(q => q.id === questionId);
            
            if (!question || state.userAnswers[questionId] !== undefined) {
                return; // Already answered
            }
            
            // Stop the question timer
            if (state.currentQuestionStartTime) {
                const timeSpent = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                state.questionTimes[state.currentQuestionIndex] = timeSpent;
                state.totalTime += timeSpent;
                state.currentQuestionStartTime = null;
            }
            
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            
            // Reset timer display
            elements.timerValueMobile.textContent = '00:00';
            elements.timerMobile.style.background = 'rgba(255, 255, 255, 0.2)';
            
            // Store answer
            state.userAnswers[questionId] = optionId;
            
            // Update UI immediately
            const optionElems = document.querySelectorAll('.option');
            optionElems.forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Add selected class to clicked option
            const selectedOption = Array.from(optionElems).find(opt => {
                const letter = opt.querySelector('.option-letter').textContent.toLowerCase();
                return letter === optionId;
            });
            
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Highlight correct/incorrect answers
            optionElems.forEach(opt => {
                const optionLetter = opt.querySelector('.option-letter').textContent.toLowerCase();
                if (optionLetter === question.correctAnswer.toLowerCase()) {
                    opt.classList.add('correct');
                } else if (optionLetter === optionId.toLowerCase() && optionId.toLowerCase() !== question.correctAnswer.toLowerCase()) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Show solution immediately
            if (question) {
                showSolution(question);
            }
            
            // Enable next button if this was the last question
            const isLastQuestion = state.currentQuestionIndex === currentQuiz.questions.length - 1;
            if (isLastQuestion) {
                elements.nextBtn.disabled = false;
            }
            
            updateSidebarStats();
            updateQuestionGrid();
        }

        function showSolution(question) {
            if (!question.solution && !question.correctAnswer) return;
            
            let solutionHTML = '';
            const userAnswer = state.userAnswers[question.id];
            
            if (question.correctAnswer) {
                const isCorrect = userAnswer === question.correctAnswer;
                solutionHTML += `
                    <p style="margin-bottom: 0.8rem; font-weight: 700; font-size: 1.1rem;">
                        <span style="color: ${isCorrect ? 'var(--success)' : 'var(--danger)'};">${isCorrect ? ' Correct!' : ' Incorrect'}</span>
                        <span style="margin-left: 10px;">
                            Answer: ${question.correctAnswer ? question.correctAnswer.toUpperCase() : 'Not available'}
                            ${userAnswer ? ` | Your Answer: ${userAnswer.toUpperCase()}` : ''}
                        </span>
                    </p>
                `;
            }
            
            if (question.solution) {
                solutionHTML += `<p>${question.solution}</p>`;
            } else {
                solutionHTML += `<p style="color: var(--gray); font-style: italic;">No detailed solution available for this question.</p>`;
            }
            
            elements.solutionText.innerHTML = solutionHTML;
            elements.solutionContainer.style.display = 'block';
            
            // Scroll to solution
            elements.solutionContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showPreviousQuestion() {
            if (state.currentQuestionIndex > 0) {
                // Stop current timer
                if (state.currentQuestionStartTime) {
                    const timeSpent = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                    state.questionTimes[state.currentQuestionIndex] = timeSpent;
                    state.totalTime += timeSpent;
                    state.currentQuestionStartTime = null;
                }
                
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
                
                state.currentQuestionIndex--;
                displayCurrentQuestion();
                updateQuestionGrid();
                
                // Scroll to top of question
                window.scrollTo(0, 0);
            }
        }

        function showNextQuestion() {
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            
            // Stop current timer
            if (state.currentQuestionStartTime) {
                const timeSpent = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                state.questionTimes[state.currentQuestionIndex] = timeSpent;
                state.totalTime += timeSpent;
                state.currentQuestionStartTime = null;
            }
            
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            
            if (state.currentQuestionIndex < currentQuiz.questions.length - 1) {
                state.currentQuestionIndex++;
                displayCurrentQuestion();
                updateQuestionGrid();
                
                // Scroll to top of question
                window.scrollTo(0, 0);
            } else {
                // If on last question and answered, enable submit
                const lastQuestionId = currentQuiz.questions[currentQuiz.questions.length - 1].id;
                if (state.userAnswers[lastQuestionId] !== undefined) {
                    elements.submitQuizBtn.style.display = 'flex';
                }
            }
        }

        function toggleQuizSidebar() {
            elements.quizSidebar.classList.toggle('show');
        }

        async function submitQuiz() {
            const confirmed = await showCustomConfirm('Submit Quiz', 'Are you sure you want to submit the quiz? You can still review answers after submission.');
            
            if (!confirmed) {
                return;
            }
            
            // Stop timer
            if (state.currentQuestionStartTime) {
                const timeSpent = Math.floor((Date.now() - state.currentQuestionStartTime) / 1000);
                state.questionTimes[state.currentQuestionIndex] = timeSpent;
                state.totalTime += timeSpent;
                state.currentQuestionStartTime = null;
            }
            
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            let correct = 0;
            let total = currentQuiz.questions.length;
            
            currentQuiz.questions.forEach(question => {
                if (state.userAnswers[question.id] === question.correctAnswer) {
                    correct++;
                }
            });
            
            state.correctAnswers = correct;
            state.incorrectAnswers = total - correct;
            state.skippedAnswers = total - Object.keys(state.userAnswers).length;
            state.quizCompleted = true;
            
            // Calculate score percentage
            const score = Math.round((correct / total) * 100);
            
            // Update performance in storage
            StorageManager.updateQuizPerformance(
                state.currentPDF.id, 
                currentQuiz.id, 
                score
            );
            
            // Show results
            showResults();
        }

        function showResults() {
            document.body.classList.remove('quiz-active');
            elements.quizSection.style.display = 'none';
            elements.resultsSection.style.display = 'block';
            
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            const total = currentQuiz.questions.length;
            const correct = state.correctAnswers;
            const score = Math.round((correct / total) * 100);
            
            // Update results display
            elements.finalScoreElem.textContent = `${score}%`;
            elements.correctCountElem.textContent = correct;
            elements.incorrectCountElem.textContent = state.incorrectAnswers;
            elements.accuracyRateElem.textContent = `${score}%`;
            
            // Calculate total time
            const totalSeconds = state.totalTime;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            elements.timeTakenElem.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Set performance rating
            let ratingText, ratingIcon, ratingClass;
            if (score >= 90) {
                ratingText = "Excellent! ";
                ratingIcon = "fas fa-crown";
                ratingClass = "rating-excellent";
            } else if (score >= 80) {
                ratingText = "Very Good! ";
                ratingIcon = "fas fa-star";
                ratingClass = "rating-very-good";
            } else if (score >= 70) {
                ratingText = "Good! ";
                ratingIcon = "fas fa-thumbs-up";
                ratingClass = "rating-good";
            } else if (score >= 60) {
                ratingText = "Average ";
                ratingIcon = "fas fa-chart-line";
                ratingClass = "rating-average";
            } else if (score >= 40) {
                ratingText = "Needs Improvement ";
                ratingIcon = "fas fa-chart-line-down";
                ratingClass = "rating-bad";
            } else {
                ratingText = "Needs Practice ";
                ratingIcon = "fas fa-book";
                ratingClass = "rating-very-bad";
            }
            
            elements.ratingText.textContent = ratingText;
            elements.ratingText.className = `rating-text ${ratingClass}`;
            elements.resultsIcon.innerHTML = `<i class="${ratingIcon}"></i>`;
            
            // Show "Practice Wrong Questions" button only if there are wrong answers
            if (state.incorrectAnswers > 0) {
                elements.reviewBtn.style.display = 'flex';
                elements.reviewBtn.innerHTML = '<i class="fas fa-redo"></i> Practice Wrong Questions';
            } else {
                elements.reviewBtn.style.display = 'none';
            }
        }

        function reviewWrongQuestions() {
            // Create a new quiz with only wrong questions
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            const wrongQuestions = currentQuiz.questions.filter(question => {
                const userAnswer = state.userAnswers[question.id];
                return userAnswer !== undefined && userAnswer !== question.correctAnswer;
            });
            
            if (wrongQuestions.length === 0) {
                showCustomAlert('No Wrong Questions', 'You have no wrong questions to practice!');
                return;
            }
            
            // Create a temporary quiz for wrong questions
            const wrongQuiz = {
                id: `wrong_${Date.now()}`,
                name: 'Practice Wrong Questions',
                subject: currentQuiz.subject,
                questions: wrongQuestions,
                totalQuestions: wrongQuestions.length,
                bestScore: 0,
                attempts: 0,
                lastAttempt: null
            };
            
            // Save the current state
            const originalQuizIndex = state.currentQuizIndex;
            const originalQuizzes = state.currentQuizzes;
            
            // Replace current quiz with wrong questions quiz
            state.currentQuizzes = [wrongQuiz];
            state.currentQuizIndex = 0;
            state.currentQuestionIndex = 0;
            state.userAnswers = {};
            state.quizStarted = true;
            state.quizCompleted = false;
            state.elapsedTime = 0;
            state.totalTime = 0;
            state.questionTimes = {};
            state.correctAnswers = 0;
            state.incorrectAnswers = 0;
            state.skippedAnswers = 0;
            
            // Add quiz-active class to body
            document.body.classList.add('quiz-active');
            
            // Update UI
            elements.resultsSection.style.display = 'none';
            elements.quizSection.style.display = 'block';
            
            // Update quiz info
            elements.totalQuestionsMobile.textContent = wrongQuestions.length;
            
            // Display first question
            displayCurrentQuestion();
            updateQuestionGrid();
            updateSidebarStats();
            
            // Restore original state when quiz is submitted
            const originalSubmitBtn = elements.submitQuizBtn.onclick;
            elements.submitQuizBtn.onclick = async function() {
                const confirmed = await showCustomConfirm('Finish Practice', 'Are you sure you want to finish practicing wrong questions?');
                if (confirmed) {
                    // Restore original state
                    state.currentQuizzes = originalQuizzes;
                    state.currentQuizIndex = originalQuizIndex;
                    elements.submitQuizBtn.onclick = originalSubmitBtn;
                    showResults();
                }
            };
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'true');
                elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                localStorage.setItem('darkMode', 'false');
                elements.themeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
        }

        function toggleDrawer() {
            elements.sidebar.classList.toggle('open');
            elements.drawerToggle.innerHTML = elements.sidebar.classList.contains('open') 
                ? '<i class="fas fa-times"></i>' 
                : '<i class="fas fa-bars"></i>';
        }

        function showShareOverlay() {
            elements.overlayTitle.textContent = 'Share PDF2QUIZ';
            elements.overlayText.innerHTML = `
                <p>Share this amazing quiz tool with others:</p>
                <div style="margin: 1.5rem 0;">
                    <input type="text" id="shareUrl" readonly 
                           style="width: 100%; padding: 0.8rem; border: 2px solid var(--primary); border-radius: 8px; font-size: 1rem; background: rgba(255,255,255,0.1); color: inherit;"
                           value="https://skpro7.github.io/pdf2quiz/">
                    <button onclick="copyShareUrl()" 
                            style="margin-top: 0.8rem; padding: 0.8rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%;">
                        <i class="fas fa-copy"></i>  Copy Link to Share
                    </button>
                </div>
                <p> Try this amazing tool to extract quizzes from PDFs and text! </p>
            `;
            elements.overlay.style.display = 'flex';
        }

        function showAboutOverlay() {
            elements.overlayTitle.textContent = 'About PDF2QUIZ';
            elements.overlayText.innerHTML = `
                <p><strong>PDF2QUIZ</strong> is an advanced tool that intelligently extracts Multiple Choice Questions from PDF files, text files, and pasted text to create interactive quizzes.</p>
                
                <h4 style="margin-top: 1.5rem; color: var(--primary);"> Key Features:</h4>
                <ul style="margin-left: 1.2rem; margin-bottom: 1.5rem; font-size: 1rem;">
                    <li>Smart extraction of questions and solutions from PDF, TXT, DOC, DOCX, RTF files</li>
                    <li>Paste text directly to create quizzes</li>
                    <li>Automatic subject and topic detection</li>
                    <li>Organizes questions into 25-question quizzes</li>
                    <li>Permanent storage of quizzes and performance tracking</li>
                    <li>Beautiful question navigator with visual indicators</li>
                    <li>Colorful, responsive design with dark/light mode</li>
                    <li>Detailed analytics and performance tracking</li>
                    <li>Review wrong answers with explanations</li>
                    <li>Support for multiple question formats (Q.1, Q.2) and solution formats (Sol.1, Sol.2)</li>
                </ul>
                
                <p><strong> How to use:</strong> Upload any file or paste text containing questions in formats like "Q.1. Question text..." and solutions like "Sol.1.(c) Solution text...". The system automatically organizes everything.</p>
                
                <p style="margin-top: 1.5rem; font-size: 0.9rem; color: var(--gray);">
                    <i class="fas fa-code"></i> Built with HTML, CSS, JavaScript & PDF.js
                </p>
            `;
            elements.overlay.style.display = 'flex';
        }

        function closeOverlay() {
            elements.overlay.style.display = 'none';
            elements.renameModal.style.display = 'none';
        }

        function downloadResults() {
            const currentQuiz = state.currentQuizzes[state.currentQuizIndex];
            const results = {
                quizDate: new Date().toISOString(),
                quizName: currentQuiz.name,
                subject: currentQuiz.subject,
                totalQuestions: currentQuiz.questions.length,
                correctAnswers: state.correctAnswers,
                incorrectAnswers: state.incorrectAnswers,
                skippedAnswers: state.skippedAnswers,
                score: Math.round((state.correctAnswers / currentQuiz.questions.length) * 100),
                timeTaken: state.totalTime,
                questions: currentQuiz.questions.map(q => ({
                    id: q.id,
                    text: q.text,
                    userAnswer: state.userAnswers[q.id],
                    correctAnswer: q.correctAnswer,
                    isCorrect: state.userAnswers[q.id] === q.correctAnswer,
                    isSkipped: state.userAnswers[q.id] === undefined,
                    solution: q.solution
                }))
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `quiz-results-${currentQuiz.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Global functions for overlay
        window.copyShareUrl = function() {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            document.execCommand('copy');
            showCustomAlert('Copied!', 'Link copied to clipboard!  Share with friends!');
        };

        // Close drawer when clicking outside on mobile
        document.addEventListener('click', (event) => {
            if (window.innerWidth <= 768 && 
                !elements.sidebar.contains(event.target) && 
                !elements.drawerToggle.contains(event.target) && 
                elements.sidebar.classList.contains('open')) {
                toggleDrawer();
            }
            
            // Close quiz sidebar when clicking outside on mobile
            if (!elements.quizSidebar.contains(event.target) && 
                !elements.questionNavigatorBtnMobile.contains(event.target) && 
                elements.quizSidebar.classList.contains('show')) {
                toggleQuizSidebar();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (elements.quizSection.style.display === 'block') {
                switch(event.key) {
                    case 'ArrowLeft':
                        if (!elements.prevBtn.disabled) showPreviousQuestion();
                        break;
                    case 'ArrowRight':
                        if (!elements.nextBtn.disabled) showNextQuestion();
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        const optionIndex = parseInt(event.key) - 1;
                        const options = document.querySelectorAll('.option');
                        if (options[optionIndex]) {
                            options[optionIndex].click();
                        }
                        break;
                    case 'Enter':
                        if (event.ctrlKey || event.metaKey) {
                            elements.submitQuizBtn.click();
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>
